box: python:2.7
dev:
  steps:
    - pip-install
    - internal/watch:
        code: python manage.py
        reload: true
# Build definition
build:
  # The steps that will be executed on build
  steps:
    # A step that executes `pip install` command
    - pip-install

    # A custom script step, name value is used in the UI
    # and the code value contains the command that get executed
    - script:
        name: API auth test
        code: |
          nosetests tests/test_auth.py
          nosetests tests/test_cache.py
    - script:
        name: API rate limit test
        code: |
          nosetests tests/test_rate_limit.py
    - script:
        name: API cache test
        code: |
          if [ -z ${ELASTICSEARCH_URL+x} ]; then nosetests tests/test_cache.py; else echo "SKIPPED! ELASTICSEARCH_URL is set to '$ELASTICSEARCH_URL'"; fi
    - script:
        name: API association endpoint test
        code: |
          if [ -z ${ELASTICSEARCH_URL+x} ]; then nosetests tests/test_association.py; else echo "SKIPPED! ELASTICSEARCH_URL is set to '$ELASTICSEARCH_URL'"; fi
    - script:
        name: API evidence endpoint test
        code: |
          if [ -z ${ELASTICSEARCH_URL+x} ]; then nosetests tests/test_evidence.py; else echo "SKIPPED! ELASTICSEARCH_URL is set to '$ELASTICSEARCH_URL'"; fi
    - script:
        name: API efo endpoint test
        code: |
          if [ -z ${ELASTICSEARCH_URL+x} ]; then nosetests tests/test_efo.py; else echo "SKIPPED! ELASTICSEARCH_URL is set to '$ELASTICSEARCH_URL'"; fi
    - script:
        name: API expression endpoint test
        code: |
          if [ -z ${ELASTICSEARCH_URL+x} ]; then nosetests tests/test_expression.py; else echo "SKIPPED! ELASTICSEARCH_URL is set to '$ELASTICSEARCH_URL'"; fi
    - script:
        name: API freetextsearch endpoint test
        code: |
          if [ -z ${ELASTICSEARCH_URL+x} ]; then nosetests tests/test_freetextsearch.py; else echo "SKIPPED! ELASTICSEARCH_URL is set to '$ELASTICSEARCH_URL'"; fi
    - script:
        name: API stats endpoint test
        code: |
          if [ -z ${ELASTICSEARCH_URL+x} ]; then nosetests tests/test_stats.py; else echo "SKIPPED! ELASTICSEARCH_URL is set to '$ELASTICSEARCH_URL'"; fi
    - script:
        name: API target endpoint test
        code: |
          if [ -z ${ELASTICSEARCH_URL+x} ]; then nosetests tests/test_target.py; else echo "SKIPPED! ELASTICSEARCH_URL is set to '$ELASTICSEARCH_URL'"; fi

push-to-gcr:
  steps:
    - internal/docker-push:
        username: _json_key
        password: $GCR_JSON_KEY_FILE
        working-dir: $WERCKER_ROOT
        tag: $WERCKER_GIT_COMMIT, $WERCKER_GIT_BRANCH
        repository: eu.gcr.io/open-targets/rest-api
        registry: https://eu.gcr.io

#deploy:
#  box: ubuntu:xenial
#  steps:
#   # Use the scratch step to build a container from scratch based on the files present
#    - internal/docker-push:
#      username: $DOCKER_USERNAME
#      password: $DOCKER_PASSWORD
#      cmd: supervisord
#      entrypoint: docker-conf/docker-entrypoint.sh
#      tag: $WERCKER_GIT_COMMIT
#      ports: "80","443","8008","8009"
#      repository: opentargets/wercker-restapi